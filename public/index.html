<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Is Water Wet?</title>
	<style>
		body {
			margin: 0;
			font-family: sans-serif;
			background: url("https://picsum.photos/id/848/1920/1080.webp?blur") no-repeat center center fixed;
			background-size: cover;
			display: flex;
			flex-direction: column;
			height: 100vh;
			overflow: hidden;
			-webkit-user-select: none;
			user-select: none;
		}

		#scene {
			flex: 1;
			position: relative;
		}

		#sprites {
			position: absolute;
			bottom: 0;
			width: 100%;
			height: 60%;
			display: flex;
			justify-content: space-between;
			align-items: flex-end;
			box-sizing: border-box;
		}

		.sprite {
			max-height: 60vh;
			max-width: 45vw;
			transition: filter 0.3s ease;
			visibility: hidden;
		}

		.dimmed {
			filter: brightness(0.4);
		}

		#dialogueBox {
			display: flex;
			background: rgba(255, 255, 255, 0.2);
			color: #fff;
			margin: 1.5rem;
			padding: 1rem;
			border-radius: 1rem;
			box-shadow: 0 0.25rem 2rem rgba(0, 0, 0, 0.1);
			backdrop-filter: blur(0.25rem);
			border: 1px solid rgba(255, 255, 255, 0.2);
			box-sizing: border-box;
			flex-direction: column;
			gap: 0.5rem;
		}

		#speaker {
			display: none;
			font-weight: bold;
			font-size: 125%;
			text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
		}

		#dialogueText {
			display: none;
			-webkit-user-select: text;
			user-select: text;
			font-size: 150%;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
		}

		#textInputContainer {
			display: none;
			gap: 0.5rem;
			box-sizing: border-box;
		}

		#textInput {
			width: calc(100% - 2rem);
			margin-right: 0.5rem;
			padding: 0.5rem 1rem;
			font-size: 125%;
			box-sizing: border-box;
			display: block;
			border-radius: 1.5rem;
			height: 3rem;
			background: rgba(0, 0, 0, 0.2);
			color: #fff;
			border: 1px solid rgba(0, 0, 0, 0.2);
		}

		#textInput::placeholder {
			color: #fff;
			opacity: 0.75;
		}

		button {
			padding: 0.5rem 1rem;
			font-size: 125%;
			background-color: #008cf1;
			color: #fff;
			border: 1px solid rgba(255, 255, 255, 0.2);
			border-radius: 1.5rem;
			box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.2);
			cursor: pointer;
			transition: background-color 0.3s ease, box-shadow 0.3s ease;
		}

		button:hover {
			background-color: #007bd2;
		}

		button:active,
		button:focus {
			box-shadow: none;
		}

		#choices {
			display: none;
			margin-top: 0.25rem;
		}

		#choices button {
			width: 4rem;
			margin-right: 0.25rem;
		}
	</style>
</head>

<body>
	<div id="scene">
		<div id="sprites">
			<img id="playerSprite" class="sprite" src="img/player.png" draggable="false" />
			<img id="philosopherSprite" class="sprite" src="img/darfin.png" draggable="false" />
		</div>

		<div id="dialogueBox">
			<div id="speaker"></div>
			<div id="dialogueText"></div>
			<div id="textInputContainer">
				<input id="textInput" placeholder="Ask your question..." />
				<button id="askButton" onclick="event.target.focus(); setTimeout(() => sendUserQuestion(), 200)">Ask</button>
			</div>
			<div id="choices"></div>
		</div>
	</div>

	<script>
		const cast = [
			{ id: "player", name: "You", color: "#fff", sprite: "img/player.png" },
			{ id: "darfin", name: "Darfin", color: "#cadef5", sprite: "img/darfin.png" },
			{ id: "sharx", name: "Sharx", color: "#b8cfe8", sprite: "img/sharx.png" },
			{ id: "nietzscheel", name: "Nietzscheel", color: "#afbe67", sprite: "img/nietzscheel.png" },
			{ id: "aristurtle", name: "Aristurtle", color: "#eadf8f", sprite: "img/aristurtle.png" },
			{ id: "socratuna", name: "Socratuna", color: "#ecad9a", sprite: "img/socratuna.png" }
		];
		function getCast(id) { return cast.find(c => c.id === id); }

		const script = [
		"@show player",
			"You are a young fish, freshly graduated from the school of Fishlosophy.",
			"You have set off on a quest to answer the deepest question of all: Is water wet?",
			"Legend has it that in deepest corners of Marianna's Stench there exist wise fishlosophers that possess vast wisdom.",
			"Your task is to venture into the depths of the sea, locate and dialogue with these great minds.",
			"Per standard fishetiquette, you may ask each fishlosopher you encounter three questions to arrive closer to the truth.",
			"Phrase your questions carefully, as they must be relevant to the task at hand and will be judged harshly!",
			"@show darfin",
			"Ah, there's one now! The legendary science professor, Darfin. Perhaps they can help.",
			"player: Hello professor! I have been pondering if water is wet, and was hoping you might help guide me to the truth.",
			"darfin: Greetings, young fish. Tis a deep question indeed. There may be a scientific, fishlosophical, or perhaps even a spiritual answer. I can share my knowledge of science, but it is up to you to find your truth. What would you like to know?",
			"@ask darfin",

			"You continue your descent, deeper into the sea.",
			"@show sharx",
			"A large mass appears in your peripheral vision - it's a shark!  To your surprise, the large beast circles you once and warmly greets you with the wave of a fin.",
			"player: Well met! I am on a quest to discover if water is wet. Do you have any insights?",
			"sharx: Hello little traveler. I am Sharx, a fishlosopher and economist. What are your thoughts so far, and what do you wish to know?",
			"@ask sharx",

			"Fish food for thought.. you decide to press on - eager to venture further down.",
			"@show nietzscheel",
			"You encounter yet another fishlosopher, an eel. They're a little scary.",
			"player: Hello there! I am seeking knowledge about the nature of water. Do you think it's wet?",
			"nietzscheel: Hello, fish. I am Nietzscheel. Do you think water is wet?",
			"@ask nietzscheel",

			"You've nearly arrived at the ocean floor. It has been rumoured that this is a place reserved for only the wisest and deepest fishlosophers.",
			"@show aristurtle",
			"You come across an old turtle with its eyes closed. Somehow they appear to be very wise - one eye opens as you begin to speak.",
			"player: Oh, wise one! I have traveled far and wide, attempting to discern if water is wet, but I have heard many conflicting ideas. Can you help me?",
			"aristurtle: Ah, something I have pondered for many moons. Tell me, what knowledge still eludes you?",
			"@ask aristurtle",

			"Finally, you arrive at the bottom of the ocean and a slow but steady voice strangely seems to speak to you from within.",
			"The all-knowing oracle, Socratuna, has foretold your arrival.",
			"@show socratuna",
			"socratuna: I sense you have a question for me.",
			"@yesno",
			"socratuna: I see...",
			"socratuna: Is water wet? I will tell you the truth...",
			"socratuna: Who cares? It doesn't matter if water is wet.",
			"The end.",
			"Play again?",
			"@end"
		];

		let state = {
			lineIndex: 0,
			isThinking: false,
			isAwaitingInput: false,
			subMode: null,
			currentPhilosopher: null,
			questionIndex: 0,
			inFinalChoice: false,
			nextAction: null,
			conversations: {}
		};

		const sceneEl = document.getElementById("scene");
		const speakerEl = document.getElementById("speaker");
		const dialogueEl = document.getElementById("dialogueText");
		const textInputContainer = document.getElementById("textInputContainer");
		const textInput = document.getElementById("textInput");
		const choicesEl = document.getElementById("choices");
		const playerSprite = document.getElementById("playerSprite");
		const philSprite = document.getElementById("philosopherSprite");

		function parseSpeakerLine(line) {
			const match = line.match(/^(\S+):\s*(.*)$/);
			if (match && !match[1].includes(" ")) {
				return { speaker: match[1], text: match[2] };
			}
			return null;
		}
		function setDialogue(text, speakerId = null) {
			if (speakerId) {
				speakerEl.style.display = "block";
				const c = getCast(speakerId);
				if (c) {
					speakerEl.textContent = c.name;
					speakerEl.style.color = c.color;
				} else {
					speakerEl.textContent = speakerId;
					speakerEl.style.color = "#fff";
				}
			} else {
				speakerEl.style.display = "none";
				speakerEl.textContent = "";
				speakerEl.style.color = "#fff";
			}
			if (text.length > 0) {
				dialogueEl.style.display = "block";
				dialogueEl.textContent = text;
			} else {
				dialogueEl.style.display = "none";
			}
			updateDim(speakerId);
		}

		function showCharacter(charId) {
			if (charId === "player") {
				playerSprite.style.visibility = "visible";
				return;
			}
			const c = getCast(charId);
			if (c) {
				philSprite.src = c.sprite;
				philSprite.style.visibility = "visible";
			}
		}
		function hideCharacter(charId) {
			if (charId === "player") {
				playerSprite.style.visibility = "hidden";
				return;
			}
			philSprite.style.visibility = "hidden";
		}

		function updateDim(speakerId) {
			if (speakerId === "player") {
				playerSprite.classList.remove("dimmed");
				philSprite.classList.add("dimmed");
			} else if (speakerId && getCast(speakerId)) {
				philSprite.classList.remove("dimmed");
				playerSprite.classList.add("dimmed");
			} else {
				playerSprite.classList.remove("dimmed");
				philSprite.classList.remove("dimmed");
			}
		}

		function nextLine() {
			if (state.inFinalChoice) return;

			if (state.subMode === "askFlow") {
				doAskFlow();
				return;
			}

			if (typeof state.nextAction === "function") {
				const fn = state.nextAction;
				state.nextAction = null;
				fn();
				return;
			}

			if (state.lineIndex >= script.length) {
				setDialogue("The end.");
				return;
			}

			const line = script[state.lineIndex].trim();
			state.lineIndex++;

			if (line.startsWith("@")) {
				const [cmdRaw, arg] = line.split(" ");
				const cmd = cmdRaw.replace("@", "").toLowerCase();
				switch (cmd) {
					case "show":
						showCharacter(arg);
						nextLine();
						return;
					case "hide":
						hideCharacter(arg);
						nextLine();
						return;
					case "ask":
						startAskFlow(arg);
						return;
					case "yesno":
						showYesNoButtons();
						return;
					case "end":
						window.location.reload();
						return;
					default:
						nextLine();
						return;
				}
			}

			const parsed = parseSpeakerLine(line);
			if (parsed) {
				setDialogue(parsed.text, parsed.speaker);
			} else {
				setDialogue(line);
			}
		}

		function showYesNoButtons() {
			setDialogue("But first... what do YOU think? Is water wet?", "socratuna");
			choicesEl.innerHTML = `
    <button onclick="chooseFinal('Yes')">Yes</button>
    <button onclick="chooseFinal('No')">No</button>
  `;
			choicesEl.style.display = "block";
			state.inFinalChoice = true;
		}
		function chooseFinal(choice) {
			if (!state.inFinalChoice) return;
			state.inFinalChoice = false;
			choicesEl.style.display = "none";
			nextLine();
		}

		function startAskFlow(philId) {
			state.subMode = "askFlow";
			state.currentPhilosopher = philId;
			state.questionIndex = 0;
			showCharacter(philId);

			const history = [];

			const lines = [
				script[state.lineIndex - 3],
				script[state.lineIndex - 2]
			];

			for (const line of lines) {
				const parsed = parseSpeakerLine(line);
				if (parsed) {
					const speaker = parsed.speaker.toLowerCase();
					const content = parsed.text;

					if (speaker === "player") {
						history.push({ role: "user", content });
					} else {
						history.push({ role: "assistant", content });
					}
				}
			}

			state.conversations[philId] = history;
			doAskFlow();
		}

		function doAskFlow() {
			if (state.questionIndex >= 3) {
				state.subMode = null;
				hideCharacter(state.currentPhilosopher);
				state.currentPhilosopher = null;
				nextLine();
				return;
			}
			setDialogue("", null);
			philSprite.classList.add("dimmed");
			textInputContainer.style.display = "flex";
			textInput.value = "";
			textInput.focus();
			state.isAwaitingInput = true;
		}

		async function sendUserQuestion() {
			if (!state.isAwaitingInput || !textInput.value.trim()) return;
			state.isAwaitingInput = false;

			const philId = state.currentPhilosopher;
			const convo = state.conversations[philId];
			const userQ = textInput.value.trim();

			textInputContainer.style.display = "none";
			setDialogue("Hmm... that's deep", philId);

			state.isThinking = true;
			let dots = 1;
			const thinkingInterval = setInterval(() => {
				setDialogue("Hmm... that's deep" + ".".repeat(++dots), philId);
			}, 500);

			try {
				convo.push({ role: "user", content: userQ });
				const res = await fetch("/ask", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ character: philId, messages: convo })
				});
				const data = await res.json();
				const reply = data.reply || "...(no reply)...";

				clearInterval(thinkingInterval);
				state.isThinking = false;
				setDialogue(reply, philId);
				convo.push({ role: "assistant", content: reply });
			} catch (err) {
				clearInterval(thinkingInterval);
				state.isThinking = false;
				setDialogue("(error from /ask)", philId);
			}

			state.nextAction = () => {
				state.nextAction = null;
				state.questionIndex++;
				doAskFlow();
			};
		}

		sceneEl.addEventListener("click", () => {
			if (state.isThinking) return;
			if (state.isAwaitingInput) return;
			if (typeof state.nextAction === "function") {
				const fn = state.nextAction;
				state.nextAction = null;
				fn();
				return;
			}
			nextLine();
		});

		document.addEventListener("keydown", e => {
			if (e.code === "Space") {
				if (document.activeElement === textInput) {
					return;
				}
				e.preventDefault();
				sceneEl.click();
			}
		});

		textInput.addEventListener("keypress", e => {
			if (e.key === "Enter") {
				sendUserQuestion();
			}
		});

		nextLine();
	</script>
</body>

</html>
